<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Chicago Breadwinners</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/custom.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.js"></script>
      <script src="js/respond.min.js"></script>
    <![endif]-->

    <link href="css/leaflet.css" rel="stylesheet">
    <!--[if lte IE 8]>
    <link href="css/leaflet.ie.css" rel="stylesheet">
    <![endif]-->
  </head>

  <body>

    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Chicago Breadwinners</a>
        </div>
        <!-- <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div> --> <!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">

      <div class="starter-template">
        <div class='row'>
          <!-- <div class='col-md-4'>
            <div class='well'>
              <h3>Monthly wages</h3>
              <p>Average monthly wages per census block in Chicago.</p>
              <h4>
                Year
                <small id='year_label'></small>
              </h4>
              <div id='slider'></div>
              <strong class='pull-left' id='start_year'></strong>
              <strong class='pull-right' id='end_year'></strong>
            </div>
          </div> -->
          <div class='col-md-12'>
            <div id='map'></div>
          </div>
        </div>
      </div>

    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/jenks.js"></script>

    <script src="data/chicago_CBSA_tracts.js"></script>

    <script>
      $(window).resize(function () {
        var h = $(window).height(),
          offsetTop = 65; // Calculate the top offset

        $('#map').css('height', (h - offsetTop));
      }).resize();

      var map = L.map('map').setView([41.882726, -87.93045], 9);

      var cloudmade = L.tileLayer('http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png', {
          attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
          key: 'BC9A493B41014CAABB98F0471D759707',
          styleId: 22677
      }).addTo(map);
      map.attributionControl.setPrefix('');

      // using dummy data for now
      var jobs_numbers = [];
      for (var i = 0; i < chicago_CBSA_tracts['features'].length; i++) {
        jobs_numbers[i] = chicago_CBSA_tracts.features[i].properties['2011']['total_jobs'];
      }

      var jenks_cutoffs = jenks(jobs_numbers, 4);
      jenks_cutoffs[0] = 0; // ensure the bottom value is 0
      jenks_cutoffs.pop(); // last item is the max value, so dont use it

      // control that shows state info on hover
      var info = L.control();

      info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
      };

      info.update = function (props) {
        this._div.innerHTML = '<h4>LODES data</h4>' +  (props ?
          '<strong>Census tract</strong>: ' + props.tract_fips + "<br /><strong>Number of jobs</strong>: " + props['2011']['total_jobs']: 'Hover over a census tract');
      };

      info.addTo(map);


      // get color depending on population density value
      function getColor(d) {
        return  d >= jenks_cutoffs[3] ? '#006D2C' :
                d >= jenks_cutoffs[2] ? '#31A354' :
                d >= jenks_cutoffs[1] ? '#74C476' :
                d >= jenks_cutoffs[0] ? '#BAE4B3' :
                                        '#EDF8E9';
      }

      function style(feature) {
        return {
          weight: 0.5,
          opacity: 1,
          color: 'white',
          fillOpacity: 0.7,
          fillColor: getColor(feature.properties['2011']['total_jobs'])
        };
      }

      function highlightFeature(e) {
        var layer = e.target;

        layer.setStyle({
          weight: 2,
          color: '#333',
          dashArray: '',
          fillOpacity: 0.7
        });

        if (!L.Browser.ie && !L.Browser.opera) {
          layer.bringToFront();
        }

        info.update(layer.feature.properties);
      }

      var geojson;
      var leaflet_tracts = {};

      function resetHighlight(e) {
        geojson.resetStyle(e.target);
        info.update();
      }

      function showConnectedTracts(e) {

        var tract_fips = e.target.feature.properties.tract_fips;
        $.ajax({
          url: ("http://ec2-54-212-141-93.us-west-2.compute.amazonaws.com/tract-origin-destination/" + tract_fips + "/"),
          type: 'GET',
          dataType: 'json',
          success: function (resp) {

            var traveling_to = resp['traveling-to'];
            var traveling_from = resp['traveling-from'];

            $.each(traveling_to, function(index, value) {
              $.each(value, function(k, v) {
                console.log(k);
                if (leaflet_tracts[k] != undefined)
                  map._layers[leaflet_tracts[k]].setStyle({fillColor: 'black'});
              });
            });

            // var tract_demo = ["8505", "8429", "8427.06"];
            // for (var i = 0; i < tract_demo.length; i++) {
            //   map._layers[leaflet_tracts[tract_demo[i]]].setStyle({fillColor: 'black'});
            // }

            //   console.log(resp);
          },
          error: function(error) {
              console.log(error);
          }  
        });
      }

      function onEachFeature(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight,
          click: showConnectedTracts
        });
      }

      geojson = L.geoJson(chicago_CBSA_tracts, {
        style: style,
        onEachFeature: onEachFeature
      }).addTo(map);

      geojson.eachLayer(function (layer) {
        leaflet_tracts[layer.feature.properties.tract_fips] = layer._leaflet_id;
      });

      map.attributionControl.addAttribution('LODES data &copy; <a href="http://census.gov/">US Census Bureau</a>');


      var legend = L.control({position: 'bottomright'});

      legend.onAdd = function (map) {

        var div = L.DomUtil.create('div', 'info legend'),
          grades = jenks_cutoffs,
          labels = [],
          from, to;

        for (var i = 0; i < grades.length; i++) {
          from = grades[i];
          to = grades[i + 1];

          labels.push(
            '<i style="background:' + getColor(from + 0.01) + '"></i> ' +
            from + (to ? '&ndash;' + to : '+'));
        }

        div.innerHTML = labels.join('<br>');
        return div;
      };

      legend.addTo(map);
    </script>

  </body>
</html>
