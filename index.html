<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Where We Work</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/custom.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.js"></script>
      <script src="js/respond.min.js"></script>
    <![endif]-->

    <link href="css/leaflet.css" rel="stylesheet">
    <!--[if lte IE 8]>
    <link href="css/leaflet.ie.css" rel="stylesheet">
    <![endif]-->
  </head>

  <body>

    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Where We Work</a>
        </div>
        <!-- <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div> --> <!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">

      <div class="starter-template">
        <div class='row'>
          <div class='col-md-4'>
            <div class='well'>
              <h3>Where We Work</h3>
              <p>Find out where people live and work in Chicago</p>
              
              <h4>Traveling to</h4>
              <ol class='color-legend'>
                <li id='legend-to-1'>Less</li>
                <li id='legend-to-2'></li>
                <li id='legend-to-3'></li>
                <li id='legend-to-4'></li>
                <li id='legend-to-5'>More</li>
              </ol>

              <h4>Traveling from</h4>
              <ol class='color-legend'>
                <li id='legend-from-1'>Less</li>
                <li id='legend-from-2'></li>
                <li id='legend-from-3'></li>
                <li id='legend-from-4'></li>
                <li id='legend-from-5'>More</li>
              </ol>

              <br />

            </div>
          </div>
          <div class='col-md-8'>
            <div id='map'></div>
          </div>
        </div>
      </div>

    </div><!-- /.container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/jenks.js"></script>

    <script src="data/chicago_CBSA_tracts.js"></script>

    <script>
      $(window).resize(function () {
        var h = $(window).height(),
          offsetTop = 65; // Calculate the top offset

        $('#map').css('height', (h - offsetTop));
      }).resize();

      var map = L.map('map').setView([41.882726, -87.93045], 9);

      var cloudmade = L.tileLayer('http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png', {
          attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
          key: 'BC9A493B41014CAABB98F0471D759707',
          styleId: 22677
      }).addTo(map);
      map.attributionControl.setPrefix('');

      // using dummy data for now
      var jobs_numbers = [];
      for (var i = 0; i < chicago_CBSA_tracts['features'].length; i++) {
        jobs_numbers[i] = chicago_CBSA_tracts.features[i].properties['2011']['total_jobs'];
      }

      var jenks_cutoffs = jenks(jobs_numbers, 4);
      jenks_cutoffs[0] = 0; // ensure the bottom value is 0
      jenks_cutoffs.pop(); // last item is the max value, so dont use it

      // control that shows state info on hover
      var info = L.control();

      info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
      };

      info.update = function (props) {
        this._div.innerHTML = (props ?
          '<strong>Census tract</strong>: ' + props.tract_fips: 'Hover over a census tract');
      };

      info.addTo(map);


      // get color depending on population density value
      function getColor(d, jenks_cutoffs) {
        return  d >= jenks_cutoffs[3] ? '#006D2C' :
                d >= jenks_cutoffs[2] ? '#31A354' :
                d >= jenks_cutoffs[1] ? '#74C476' :
                d >= jenks_cutoffs[0] ? '#BAE4B3' :
                                        '#EDF8E9';
      }

      function getColorTravelingTo(d, jenks_cutoffs) {
        return  d >= jenks_cutoffs[3] ? '#A50F15' :
                d >= jenks_cutoffs[2] ? '#DE2D26' :
                d >= jenks_cutoffs[1] ? '#FB6A4A' :
                d >= jenks_cutoffs[0] ? '#FCAE91' :
                                        '#FEE5D9';
      }

      function getColorTravelingFrom(d, jenks_cutoffs) {
        return  d >= jenks_cutoffs[3] ? '#08519C' :
                d >= jenks_cutoffs[2] ? '#3182BD' :
                d >= jenks_cutoffs[1] ? '#6BAED6' :
                d >= jenks_cutoffs[0] ? '#BDD7E7' :
                                        '#EFF3FF';
      }

      function style(feature) {
        return {
          weight: 0.5,
          opacity: 1,
          color: 'white',
          fillOpacity: 0.7,
          fillColor: '#aaa' //getColor(feature.properties['2011']['total_jobs'], jenks_cutoffs)
        };
      }

      function highlightFeature(e) {
        var layer = e.target;

        layer.setStyle({
          weight: 2,
          color: '#333',
          dashArray: '',
          fillOpacity: 0.7
        });

        if (!L.Browser.ie && !L.Browser.opera) {
          layer.bringToFront();
        }

        info.update(layer.feature.properties);
      }

      var geojson;
      var leaflet_tracts = {};

      function resetHighlight(e) {

        e.target.setStyle({
          weight: 0.5,
          opacity: 1,
          color: 'white',
        });

        //geojson.resetStyle(e.target);
        info.update();
      }

      function getConnectedTracts(e) {

        var tract_fips = e.target.feature.properties.tract_fips;
        $.ajax({
          url: ("http://ec2-54-212-141-93.us-west-2.compute.amazonaws.com/tract-origin-destination/" + tract_fips + "/2011/"),
          type: 'GET',
          dataType: 'json',
          success: function (resp) {

            geojson.eachLayer(function (layer) {
              geojson.resetStyle(layer);
            });

            displayOriginDestination(resp['traveling-to'], 'traveling-to');
            displayOriginDestination(resp['traveling-from'], 'traveling-from');

          },
          error: function(error) {
              console.log(error);
          }  
        });
      }

      function displayOriginDestination(tracts, type) {
        var jenks_numbers = [];
        $.each(tracts, function(index, value) {
          $.each(value, function(k, v) {
            jenks_numbers.push(v);
          });
        });

        var tract_jenks_cutoffs = jenks(jenks_numbers, 4);
        tract_jenks_cutoffs[0] = 0; // ensure the bottom value is 0
        tract_jenks_cutoffs.pop(); // last item is the max value, so dont use it

        $.each(tracts, function(index, value) {
          $.each(value, function(k, v) {
            console.log(k);
            if (leaflet_tracts[k] != undefined)
              if (type == 'traveling-to')
                map._layers[leaflet_tracts[k]].setStyle({fillColor: getColorTravelingTo(v, tract_jenks_cutoffs)});
              else
                map._layers[leaflet_tracts[k]].setStyle({fillColor: getColorTravelingFrom(v, tract_jenks_cutoffs)});
          });
        });

      }

      function onEachFeature(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight,
          click: getConnectedTracts
        });
      }

      geojson = L.geoJson(chicago_CBSA_tracts, {
        style: style,
        onEachFeature: onEachFeature
      }).addTo(map);

      geojson.eachLayer(function (layer) {
        leaflet_tracts[layer.feature.properties.tract_fips] = layer._leaflet_id;
      });

      map.attributionControl.addAttribution('LODES data &copy; <a href="http://census.gov/">US Census Bureau</a>');


      // var legend = L.control({position: 'bottomright'});

      // legend.onAdd = function (map) {

      //   var div = L.DomUtil.create('div', 'info legend'),
      //     grades = jenks_cutoffs,
      //     labels = [],
      //     from, to;

      //   for (var i = 0; i < grades.length; i++) {
      //     from = grades[i];
      //     to = grades[i + 1];

      //     labels.push(
      //       '<i style="background:' + getColor(from + 0.01, jenks_cutoffs) + '"></i> ' +
      //       from + (to ? '&ndash;' + to : '+'));
      //   }

      //   div.innerHTML = labels.join('<br>');
      //   return div;
      // };

      // legend.addTo(map);
    </script>

  </body>
</html>
